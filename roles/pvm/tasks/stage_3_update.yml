---
- name: Update VM
  community.general.proxmox_kvm:
   acpi: "{{ item['acpi'] if item.get('acpi') else ( pvm_override['acpi'] if pvm_override['acpi'] else omit )}}"
   agent: "{{ item['agent'] if item.get('agent') else ( pvm_override['agent'] if pvm_override['agent'] else omit ) }}"
   api_host: "{{ item['api_host'] if item.get('api_host') else ( pvm_override['api_host'] if pvm_override['api_host'] else omit ) }}"
   api_password: "{{ item['api_password'] if item.get('api_password') else ( pvm_override['api_password'] if pvm_override['api_password'] else omit ) }}"
   api_user: "{{ item['api_user'] if item.get('api_user') else ( pvm_override['api_user'] if pvm_override['api_user'] else omit ) }}"
   api_token_secret: "{{ item['api_token_secret'] if item.get('api_token_secret') else ( pvm_override['api_token_secret'] if pvm_override['api_token_secret'] else omit ) }}"
   api_token_id: "{{ item['api_token_id'] if item.get('api_token_id') else ( pvm_override['api_token_id'] if pvm_override['api_token_id'] else omit ) }}"
   args: "{{ item['args'] if item.get('args') else ( pvm_override['args'] if pvm_override['args'] else omit ) }}"
   autostart: "{{ item['autostart'] if item.get('autostart') else ( pvm_override['autostart'] if pvm_override['autostart'] else omit ) }}"
   balloon: "{{ item['balloon'] if item.get('balloon') else ( pvm_override['balloon'] if pvm_override['balloon'] else omit ) }}"
   bios: "{{ item['bios'] if item.get('bios') else ( pvm_override['bios'] if pvm_override['bios'] else omit ) }}"
   boot: "{{ item['boot'] if item.get('boot') else ( pvm_override['boot'] if pvm_override['boot'] else omit ) }}"
   bootdisk: "{{ item['bootdisk'] if item.get('bootdisk') else ( pvm_override['bootdisk'] if pvm_override['bootdisk'] else omit ) }}"
   cores: "{{ item['cores'] if item.get('cores') else ( pvm_override['cores'] if pvm_override['cores'] else '1' ) }}"
   cpu: "{{ item['cpu'] if item.get('cpu') else ( pvm_override['cpu'] if pvm_override['cpu'] else omit ) }}"
   cpulimit: "{{ item['cpulimit'] if item.get('cpulimit') else ( pvm_override['cpulimit'] if pvm_override['cpulimit'] else omit ) }}"
   cpuunits: "{{ item['cpuunits'] if item.get('cpuunits') else ( pvm_override['cpuunits'] if pvm_override['cpuunits'] else omit ) }}"
   delete: "{{ item['delete'] if item.get('delete') else ( pvm_override['delete'] if pvm_override['delete'] else omit ) }}"
   description: "{{ item['description'] if item.get('description') else ( pvm_override['description'] if pvm_override['description'] else omit ) }}"
   digest: "{{ item['digest'] if item.get('digest') else ( pvm_override['digest'] if pvm_override['digest'] else omit ) }}"
   force: "{{ item['force'] if item.get('force') else ( pvm_override['force'] if pvm_override['force'] else omit ) }}"
   format: "{{ item['format'] if item.get('format') else ( pvm_override['format'] if pvm_override['format'] else omit ) }}"
   freeze: "{{ item['freeze'] if item.get('freeze') else ( pvm_override['freeze'] if pvm_override['freeze'] else omit ) }}"
   full: "{{ item['full'] if item.get('full') else ( pvm_override['full'] if pvm_override['full'] else omit ) }}"
   hostpci: "{{ item['hostpci'] if item.get('hostpci') else ( pvm_override['hostpci'] if pvm_override['hostpci'] else omit ) }}"
   hotplug: "{{ item['hotplug'] if item.get('hotplug') else ( pvm_override['hotplug'] if pvm_override['hotplug'] else omit ) }}"
   hugepages: "{{ item['hugepages'] if item.get('hugepages') else ( pvm_override['hugepages'] if pvm_override['hugepages'] else omit ) }}"
   ide: "{{ item['ide'] if item.get('ide') else ( pvm_override['ide'] if pvm_override['ide'] else omit ) }}"
   keyboard: "{{ item['keyboard'] if item.get('keyboard') else ( pvm_override['keyboard'] if pvm_override['keyboard'] else omit ) }}"
   kvm: "{{ item['kvm'] if item.get('kvm') else ( pvm_override['kvm'] if pvm_override['kvm'] else omit ) }}"
   localtime: "{{ item['localtime'] if item.get('localtime') else ( pvm_override['localtime'] if pvm_override['localtime'] else omit ) }}"
   lock: "{{ item['lock'] if item.get('lock') else ( pvm_override['lock'] if pvm_override['lock'] else omit ) }}"
   machine: "{{ item['machine'] if item.get('machine') else ( pvm_override['machine'] if pvm_override['machine'] else omit ) }}"
   memory: "{{ item['memory'] if item.get('memory') else ( pvm_override['memory'] if pvm_override['memory'] else '512' ) }}"
   migrate_downtime: "{{ item['migrate_downtime'] if item.get('migrate_downtime') else ( pvm_override['migrate_downtime'] if pvm_override['migrate_downtime'] else omit ) }}"
   migrate_speed: "{{ item['migrate_speed'] if item.get('migrate_speed') else ( pvm_override['migrate_speed'] if pvm_override['migrate_speed'] else omit ) }}"
   name: "{{ item['name'] if item.get('name') else ( pvm_override['name'] if pvm_override['name'] else omit ) }}"
   net: "{{ item['net'] if item.get('net') else ( pvm_override['net'] if pvm_override['net'] else omit ) }}"
   newid: "{{ item['newid'] if item.get('newid') else ( pvm_override['newid'] if pvm_override['newid'] else omit ) }}"
   node: "{{ item['node'] if item.get('node') else ( pvm_override['node'] if pvm_override['node'] else omit ) }}"
   numa: "{{ item['numa'] if item.get('numa') else ( pvm_override['numa'] if pvm_override['numa'] else omit ) }}"
   numa_enabled: "{{ item['numa_enabled'] if item.get('numa_enabled') else ( pvm_override['numa_enabled'] if pvm_override['numa_enabled'] else omit ) }}"
   onboot: "{{ item['onboot'] if item.get('onboot') else ( pvm_override['onboot'] if pvm_override['onboot'] else omit ) }}"
   ostype: "{{ item['ostype'] if item.get('ostype') else ( pvm_override['ostype'] if pvm_override['ostype'] else omit ) }}"
   parallel: "{{ item['parallel'] if item.get('parallel') else ( pvm_override['parallel'] if pvm_override['parallel'] else omit ) }}"
   pool: "{{ item['pool'] if item.get('pool') else ( pvm_override['pool'] if pvm_override['pool'] else omit ) }}"
   protection: "{{ item['protection'] if item.get('protection') else ( pvm_override['protection'] if pvm_override['protection'] else omit ) }}"
   proxmox_default_behavior: "{{ item['proxmox_default_behavior'] if item.get('proxmox_default_behavior') else ( pvm_override['proxmox_default_behavior'] if pvm_override['proxmox_default_behavior'] else omit ) }}"
   reboot: "{{ item['reboot'] if item.get('reboot') else ( pvm_override['reboot'] if pvm_override['reboot'] else omit ) }}"
   revert: "{{ item['revert'] if item.get('revert') else ( pvm_override['revert'] if pvm_override['revert'] else omit ) }}"
   sata: "{{ item['sata'] if item.get('sata') else ( pvm_override['sata'] if pvm_override['sata'] else omit ) }}"
   scsi: "{{ item['scsi'] if item.get('scsi') else ( pvm_override['scsi'] if pvm_override['scsi'] else omit ) }}"
   scsihw: "{{ item['scsihw'] if item.get('scsihw') else ( pvm_override['scsihw'] if pvm_override['scsihw'] else omit ) }}"
   serial: "{{ item['serial'] if item.get('serial') else ( pvm_override['serial'] if pvm_override['serial'] else omit ) }}"
   shares: "{{ item['shares'] if item.get('shares') else ( pvm_override['shares'] if pvm_override['shares'] else omit ) }}"
   skiplock: "{{ item['skiplock'] if item.get('skiplock') else ( pvm_override['skiplock'] if pvm_override['skiplock'] else omit ) }}"
   smbios: "{{ item['smbios'] if item.get('smbios') else ( pvm_override['smbios'] if pvm_override['smbios'] else omit ) }}"
   snapname: "{{ item['snapname'] if item.get('snapname') else ( pvm_override['snapname'] if pvm_override['snapname'] else omit ) }}"
   sockets: "{{ item['sockets'] if item.get('sockets') else ( pvm_override['sockets'] if pvm_override['sockets'] else omit ) }}"
   startdate: "{{ item['startdate'] if item.get('startdate') else ( pvm_override['startdate'] if pvm_override['startdate'] else omit ) }}"
   startup: "{{ item['startup'] if item.get('startup') else ( pvm_override['startup'] if pvm_override['startup'] else omit ) }}"
   state: "{{ item['state'] if item.get('state') else ( pvm_override['state'] if pvm_override['state'] else omit ) }}"
   storage: "{{ item['storage'] if item.get('storage') else ( pvm_override['storage'] if pvm_override['storage'] else omit ) }}"
   tablet: "{{ item['tablet'] if item.get('tablet') else ( pvm_override['tablet'] if pvm_override['tablet'] else omit ) }}"
   target: "{{ item['target'] if item.get('target') else ( pvm_override['target'] if pvm_override['target'] else omit ) }}"
   tdf: "{{ item['tdf'] if item.get('tdf') else ( pvm_override['tdf'] if pvm_override['tdf'] else omit ) }}"
   template: "{{ item['template'] if item.get('template') else ( pvm_override['template'] if pvm_override['template'] else omit ) }}"
   timeout: "{{ item['timeout'] if item.get('timeout') else ( pvm_override['timeout'] if pvm_override['timeout'] else omit ) }}"
   update: "{{ item['update'] if item.get('update') else ( pvm_override['update'] if pvm_override['update'] else omit ) }}"
   validate_certs: "{{ item['validate_certs'] if item.get('validate_certs') else ( pvm_override['validate_certs'] if pvm_override['validate_certs'] else omit ) }}"
   vcpus: "{{ item['vcpus'] if item.get('vcpus') else ( pvm_override['vcpus'] if pvm_override['vcpus'] else omit ) }}"
   vga: "{{ item['vga'] if item.get('vga') else ( pvm_override['vga'] if pvm_override['vga'] else omit ) }}"
   virtio: "{{ item['virtio'] if item.get('virtio') else ( pvm_override['virtio'] if pvm_override['virtio'] else omit ) }}"
   vmid: "{{ item['vmid'] if item.get('vmid') else ( pvm_override['vmid'] if pvm_override['vmid'] else omit ) }}"
   watchdog: "{{ item['watchdog'] if item.get('watchdog') else ( pvm_override['watchdog'] if pvm_override['watchdog'] else omit ) }}"
  delegate_to: localhost
  with_items: "{{ pvm_list | default([]) }}"
  when:
   - pvm_operation is not defined



- name: Update VM using tags
  community.general.proxmox_kvm:
     acpi: "{{ item['acpi'] if item.get('acpi') else ( pvm_override['acpi'] if pvm_override['acpi'] else omit )}}"
     agent: "{{ item['agent'] if item.get('agent') else ( pvm_override['agent'] if pvm_override['agent'] else omit ) }}"
     api_host: "{{ item['api_host'] if item.get('api_host') else ( pvm_override['api_host'] if pvm_override['api_host'] else omit ) }}"
     api_password: "{{ item['api_password'] if item.get('api_password') else ( pvm_override['api_password'] if pvm_override['api_password'] else omit ) }}"
     api_user: "{{ item['api_user'] if item.get('api_user') else ( pvm_override['api_user'] if pvm_override['api_user'] else omit ) }}"
     api_token_secret: "{{ item['api_token_secret'] if item.get('api_token_secret') else ( pvm_override['api_token_secret'] if pvm_override['api_token_secret'] else omit ) }}"
     api_token_id: "{{ item['api_token_id'] if item.get('api_token_id') else ( pvm_override['api_token_id'] if pvm_override['api_token_id'] else omit ) }}"
     args: "{{ item['args'] if item.get('args') else ( pvm_override['args'] if pvm_override['args'] else omit ) }}"
     autostart: "{{ item['autostart'] if item.get('autostart') else ( pvm_override['autostart'] if pvm_override['autostart'] else omit ) }}"
     balloon: "{{ item['balloon'] if item.get('balloon') else ( pvm_override['balloon'] if pvm_override['balloon'] else omit ) }}"
     bios: "{{ item['bios'] if item.get('bios') else ( pvm_override['bios'] if pvm_override['bios'] else omit ) }}"
     boot: "{{ item['boot'] if item.get('boot') else ( pvm_override['boot'] if pvm_override['boot'] else omit ) }}"
     bootdisk: "{{ item['bootdisk'] if item.get('bootdisk') else ( pvm_override['bootdisk'] if pvm_override['bootdisk'] else omit ) }}"
     cores: "{{ item['cores'] if item.get('cores') else ( pvm_override['cores'] if pvm_override['cores'] else '1' ) }}"
     cpu: "{{ item['cpu'] if item.get('cpu') else ( pvm_override['cpu'] if pvm_override['cpu'] else omit ) }}"
     cpulimit: "{{ item['cpulimit'] if item.get('cpulimit') else ( pvm_override['cpulimit'] if pvm_override['cpulimit'] else omit ) }}"
     cpuunits: "{{ item['cpuunits'] if item.get('cpuunits') else ( pvm_override['cpuunits'] if pvm_override['cpuunits'] else omit ) }}"
     delete: "{{ item['delete'] if item.get('delete') else ( pvm_override['delete'] if pvm_override['delete'] else omit ) }}"
     description: "{{ item['description'] if item.get('description') else ( pvm_override['description'] if pvm_override['description'] else omit ) }}"
     digest: "{{ item['digest'] if item.get('digest') else ( pvm_override['digest'] if pvm_override['digest'] else omit ) }}"
     force: "{{ pvm_force if pvm_force is defined else omit }}"
     format: "{{ item['format'] if item.get('format') else ( pvm_override['format'] if pvm_override['format'] else omit ) }}"
     freeze: "{{ item['freeze'] if item.get('freeze') else ( pvm_override['freeze'] if pvm_override['freeze'] else omit ) }}"
     full: "{{ item['full'] if item.get('full') else ( pvm_override['full'] if pvm_override['full'] else omit ) }}"
     hostpci: "{{ item['hostpci'] if item.get('hostpci') else ( pvm_override['hostpci'] if pvm_override['hostpci'] else omit ) }}"
     hotplug: "{{ item['hotplug'] if item.get('hotplug') else ( pvm_override['hotplug'] if pvm_override['hotplug'] else omit ) }}"
     hugepages: "{{ item['hugepages'] if item.get('hugepages') else ( pvm_override['hugepages'] if pvm_override['hugepages'] else omit ) }}"
     ide: "{{ item['ide'] if item.get('ide') else ( pvm_override['ide'] if pvm_override['ide'] else omit ) }}"
     keyboard: "{{ item['keyboard'] if item.get('keyboard') else ( pvm_override['keyboard'] if pvm_override['keyboard'] else omit ) }}"
     kvm: "{{ item['kvm'] if item.get('kvm') else ( pvm_override['kvm'] if pvm_override['kvm'] else omit ) }}"
     localtime: "{{ item['localtime'] if item.get('localtime') else ( pvm_override['localtime'] if pvm_override['localtime'] else omit ) }}"
     lock: "{{ item['lock'] if item.get('lock') else ( pvm_override['lock'] if pvm_override['lock'] else omit ) }}"
     machine: "{{ item['machine'] if item.get('machine') else ( pvm_override['machine'] if pvm_override['machine'] else omit ) }}"
     memory: "{{ item['memory'] if item.get('memory') else ( pvm_override['memory'] if pvm_override['memory'] else '512' ) }}"
     migrate_downtime: "{{ item['migrate_downtime'] if item.get('migrate_downtime') else ( pvm_override['migrate_downtime'] if pvm_override['migrate_downtime'] else omit ) }}"
     migrate_speed: "{{ item['migrate_speed'] if item.get('migrate_speed') else ( pvm_override['migrate_speed'] if pvm_override['migrate_speed'] else omit ) }}"
     name: "{{ item['name'] if item.get('name') else ( pvm_override['name'] if pvm_override['name'] else omit ) }}"
     net: "{{ item['net'] if item.get('net') else ( pvm_override['net'] if pvm_override['net'] else omit ) }}"
     newid: "{{ item['newid'] if item.get('newid') else ( pvm_override['newid'] if pvm_override['newid'] else omit ) }}"
     node: "{{ item['node'] if item.get('node') else ( pvm_override['node'] if pvm_override['node'] else omit ) }}"
     numa: "{{ item['numa'] if item.get('numa') else ( pvm_override['numa'] if pvm_override['numa'] else omit ) }}"
     numa_enabled: "{{ item['numa_enabled'] if item.get('numa_enabled') else ( pvm_override['numa_enabled'] if pvm_override['numa_enabled'] else omit ) }}"
     onboot: "{{ item['onboot'] if item.get('onboot') else ( pvm_override['onboot'] if pvm_override['onboot'] else omit ) }}"
     ostype: "{{ item['ostype'] if item.get('ostype') else ( pvm_override['ostype'] if pvm_override['ostype'] else omit ) }}"
     parallel: "{{ item['parallel'] if item.get('parallel') else ( pvm_override['parallel'] if pvm_override['parallel'] else omit ) }}"
     pool: "{{ item['pool'] if item.get('pool') else ( pvm_override['pool'] if pvm_override['pool'] else omit ) }}"
     protection: "{{ item['protection'] if item.get('protection') else ( pvm_override['protection'] if pvm_override['protection'] else omit ) }}"
     proxmox_default_behavior: "{{ item['proxmox_default_behavior'] if item.get('proxmox_default_behavior') else ( pvm_override['proxmox_default_behavior'] if pvm_override['proxmox_default_behavior'] else omit ) }}"
     reboot: "{{ item['reboot'] if item.get('reboot') else ( pvm_override['reboot'] if pvm_override['reboot'] else omit ) }}"
     revert: "{{ item['revert'] if item.get('revert') else ( pvm_override['revert'] if pvm_override['revert'] else omit ) }}"
     sata: "{{ item['sata'] if item.get('sata') else ( pvm_override['sata'] if pvm_override['sata'] else omit ) }}"
     scsi: "{{ item['scsi'] if item.get('scsi') else ( pvm_override['scsi'] if pvm_override['scsi'] else omit ) }}"
     scsihw: "{{ item['scsihw'] if item.get('scsihw') else ( pvm_override['scsihw'] if pvm_override['scsihw'] else omit ) }}"
     serial: "{{ item['serial'] if item.get('serial') else ( pvm_override['serial'] if pvm_override['serial'] else omit ) }}"
     shares: "{{ item['shares'] if item.get('shares') else ( pvm_override['shares'] if pvm_override['shares'] else omit ) }}"
     skiplock: "{{ item['skiplock'] if item.get('skiplock') else ( pvm_override['skiplock'] if pvm_override['skiplock'] else omit ) }}"
     smbios: "{{ item['smbios'] if item.get('smbios') else ( pvm_override['smbios'] if pvm_override['smbios'] else omit ) }}"
     snapname: "{{ item['snapname'] if item.get('snapname') else ( pvm_override['snapname'] if pvm_override['snapname'] else omit ) }}"
     sockets: "{{ item['sockets'] if item.get('sockets') else ( pvm_override['sockets'] if pvm_override['sockets'] else omit ) }}"
     startdate: "{{ item['startdate'] if item.get('startdate') else ( pvm_override['startdate'] if pvm_override['startdate'] else omit ) }}"
     startup: "{{ item['startup'] if item.get('startup') else ( pvm_override['startup'] if pvm_override['startup'] else omit ) }}"
     state: "{{ pvm_operation }}"
     storage: "{{ item['storage'] if item.get('storage') else ( pvm_override['storage'] if pvm_override['storage'] else omit ) }}"
     tablet: "{{ item['tablet'] if item.get('tablet') else ( pvm_override['tablet'] if pvm_override['tablet'] else omit ) }}"
     target: "{{ item['target'] if item.get('target') else ( pvm_override['target'] if pvm_override['target'] else omit ) }}"
     tdf: "{{ item['tdf'] if item.get('tdf') else ( pvm_override['tdf'] if pvm_override['tdf'] else omit ) }}"
     template: "{{ item['template'] if item.get('template') else ( pvm_override['template'] if pvm_override['template'] else omit ) }}"
     timeout: "{{ item['timeout'] if item.get('timeout') else ( pvm_override['timeout'] if pvm_override['timeout'] else omit ) }}"
     update: "{{ pvm_update if pvm_update is defined else (item['update'] if item.get('update') else ( pvm_override['update'] if pvm_override['update'] else omit )) }}"
     validate_certs: "{{ item['validate_certs'] if item.get('validate_certs') else ( pvm_override['validate_certs'] if pvm_override['validate_certs'] else omit ) }}"
     vcpus: "{{ item['vcpus'] if item.get('vcpus') else ( pvm_override['vcpus'] if pvm_override['vcpus'] else omit ) }}"
     vga: "{{ item['vga'] if item.get('vga') else ( pvm_override['vga'] if pvm_override['vga'] else omit ) }}"
     virtio: "{{ item['virtio'] if item.get('virtio') else ( pvm_override['virtio'] if pvm_override['virtio'] else omit ) }}"
     vmid: "{{ item['vmid'] if item.get('vmid') else ( pvm_override['vmid'] if pvm_override['vmid'] else omit ) }}"
     watchdog: "{{ item['watchdog'] if item.get('watchdog') else ( pvm_override['watchdog'] if pvm_override['watchdog'] else omit ) }}"
  delegate_to: localhost
  with_items: "{{ pvm_list | default([]) }}"
  when:
   - pvm_operation is defined

- name: Show VM disks and their sizes
  debug:
    msg:
      - "vm: {{ item.0.name }}"
      - "disk: {{ item.1.name }}"
      - "size: {{ item.1.size if item.1.size is defined }}"
  loop: "{{ pvm_list | subelements('disks',skip_missing=True) }}"
  when: 
   - pvm_operation is not defined
   - item.1.name is defined and item.0.name is defined

- name: Update Proxmox Disk Resized
  community.general.proxmox_disk:
   api_host: "{{ item.0['api_host'] if item.0.get('api_host') else ( pvm_override['api_host'] if pvm_override['api_host'] else omit ) }}"
   api_password: "{{ item.0['api_password'] if item.0.get('api_password') else ( pvm_override['api_password'] if pvm_override['api_password'] else omit ) }}"
   api_user: "{{ item.0['api_user'] if item.0.get('api_user') else ( pvm_override['api_user'] if pvm_override['api_user'] else omit ) }}"
   api_token_secret: "{{ item.0['api_token_secret'] if item.0.get('api_token_secret') else ( pvm_override['api_token_secret'] if pvm_override['api_token_secret'] else omit ) }}"
   api_token_id: "{{ item.0['api_token_id'] if item.0.get('api_token_id') else ( pvm_override['api_token_id'] if pvm_override['api_token_id'] else omit ) }}"
   vmid: "{{ item.0['vmid'] if item.0.get('vmid') else ( pvm_override['vmid'] if pvm_override['vmid'] else omit ) }}"
   name: "{{ item.0['name'] if item.0.get('name') else ( pvm_override['name'] if pvm_override['name'] else omit ) }}"
   disk: "{{ item.1.name }}"
   format: "{{ item.1.format if item.1.format is defined else omit }}"
   storage: "{{ item.0['storage'] if item.0.get('storage') else ( pvm_override['storage'] if pvm_override['storage'] else omit ) }}"
   size: "{{ item.1.size|string + 'G' if item.1.size is defined }}"
   create: "{{ item.1.create if item.1.create is defined else omit }}"
   state: "resized"
   cache: "{{ item.1.cache if item.1.cache is defined else omit }}"
   ssd: "{{ item.1.ssd if item.1.ssd is defined else omit }}"
   aio: "{{ item.1.aio if item.1.aio is defined else omit }}"
   iothread: "{{ item.1.iothread if item.1.iothread is defined else omit }}"
  delegate_to: localhost
  loop: "{{ pvm_list | subelements('disks',skip_missing=True) }}"
  when: 
   - pvm_operation is not defined
   - item.1.name is defined and item.0.name is defined


- name: Update Proxmox Disk Parameters
  community.general.proxmox_disk:
   api_host: "{{ item.0['api_host'] if item.0.get('api_host') else ( pvm_override['api_host'] if pvm_override['api_host'] else omit ) }}"
   api_password: "{{ item.0['api_password'] if item.0.get('api_password') else ( pvm_override['api_password'] if pvm_override['api_password'] else omit ) }}"
   api_user: "{{ item.0['api_user'] if item.0.get('api_user') else ( pvm_override['api_user'] if pvm_override['api_user'] else omit ) }}"
   api_token_secret: "{{ item.0['api_token_secret'] if item.0.get('api_token_secret') else ( pvm_override['api_token_secret'] if pvm_override['api_token_secret'] else omit ) }}"
   api_token_id: "{{ item.0['api_token_id'] if item.0.get('api_token_id') else ( pvm_override['api_token_id'] if pvm_override['api_token_id'] else omit ) }}"
   vmid: "{{ item.0['vmid'] if item.0.get('vmid') else ( pvm_override['vmid'] if pvm_override['vmid'] else omit ) }}"
   name: "{{ item.0['name'] if item.0.get('name') else ( pvm_override['name'] if pvm_override['name'] else omit ) }}"
   disk: "{{ item.1.name }}"
   format: "{{ item.1.format if item.1.format is defined else omit }}"
   storage: "{{ item.0['storage'] if item.0.get('storage') else ( pvm_override['storage'] if pvm_override['storage'] else omit ) }}"
   size: "{{ item.1.size|string + 'G' if item.1.size is defined }}"
   create: "{{ item.1.create if item.1.create is defined else omit }}"
   state: "present"
   cache: "{{ item.1.cache if item.1.cache is defined else omit }}"
   ssd: "{{ item.1.ssd if item.1.ssd is defined else omit }}"
   aio: "{{ item.1.aio if item.1.aio is defined else omit }}"
   iothread: "{{ item.1.iothread if item.1.iothread is defined else omit }}"
  delegate_to: localhost
  loop: "{{ pvm_list | subelements('disks',skip_missing=True) }}"
  when: 
   - pvm_operation is not defined
   - item.1.name is defined and item.0.name is defined
